name: Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-archive:
    name: Build Archive
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Cache Ruby gems
      uses: actions/cache@v4
      with:
        path: vendor/bundle
        key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-gems-

    - name: Install dependencies
      run: |
        bundle config path vendor/bundle
        bundle install --jobs 4 --retry 3

    - name: Setup secrets
      run: |
        echo "TMDBAPIKey=${{ secrets.TMDB_API_KEY }}" > .env
        echo "FirebaseAPIKey=${{ secrets.FIREBASE_API_KEY }}" >> .env
        echo "APIBaseURL=https://api.themoviedb.org/3" >> .env
        bundle exec arkana -e .env

    - name: Resolve dependencies
      run: xcodebuild -resolvePackageDependencies -project IMDUMB.xcodeproj

    - name: Build Release
      run: bundle exec fastlane build_release

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: IMDUMB-build
        path: build/
        retention-days: 90

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/IMDUMB.ipa
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
